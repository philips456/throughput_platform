{% extends "base.html" %}
{% load static %}
{% block title %}MLflow Metrics - SynergyX{% endblock %}

{% block content %}

<!-- Loading Spinner -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="flex items-center">
    <svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l5-5-5-5v4a12 12 0 00-12 12h4l5-5-5-5v4z"></path>
    </svg>
  </div>
</div>

<script>
  // JavaScript to hide loading spinner after 1 second
  setTimeout(function() {
    document.getElementById("loading").style.display = "none";
  }, 500);  // 500 milliseconds = 1 second
</script>
<div class="p-8 space-y-8">
  <div class="flex items-center justify-between">
    <h1 class="text-3xl font-bold text-cyan-400">Model Metrics</h1>
    <a href="http://localhost:5000" target="_blank" class="px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 transition flex items-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
      </svg>
      Open MLflow UI
    </a>
  </div>
  
  <p class="text-lg text-gray-300 mb-8">Track and compare model performance metrics across different runs and experiments.</p>
  
  <!-- Model Selection -->
  <div class="bg-gray-800 p-6 rounded-2xl shadow-xl mb-8">
    <h2 class="text-xl font-semibold text-cyan-300 mb-4">Select Model</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <button id="rawModelBtn" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-600 model-btn active">Raw Throughput Model</button>
      <button id="smoothedModelBtn" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-600 model-btn">Smoothed Throughput Model</button>
      <button id="hybridModelBtn" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-600 model-btn">Hybrid Throughput Model</button>
    </div>
  </div>
  
  <!-- Metrics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- R² Metric -->
    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-cyan-300">R² Score</h3>
        <div class="bg-cyan-500/20 p-2 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
      </div>
      <div class="text-4xl font-bold text-white mb-2 r2-value">0.86</div>
      <p class="text-sm text-gray-400">Coefficient of determination (higher is better)</p>
      <div class="mt-4">
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div class="bg-cyan-500 h-2.5 rounded-full r2-bar" style="width: 87%"></div>
        </div>
      </div>
    </div>
    
    <!-- MAE Metric -->
    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-cyan-300">MAE (mbps)</h3>
        <div class="bg-red-500/20 p-2 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
          </svg>
        </div>
      </div>
      <div class="text-4xl font-bold text-white mb-2 MAE-value">102.60</div>
      <p class="text-sm text-gray-400">Mean Squared Error (lower is better)</p>
      <div class="mt-4">
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div class="bg-red-500 h-2.5 rounded-full MAE-bar" style="width: 25%"></div>
        </div>
      </div>
    </div>
    
    <!-- RMSE Metric -->
    <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-cyan-300">RMSE (mbps)</h3>
        <div class="bg-orange-500/20 p-2 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
          </svg>
        </div>
      </div>
      <div class="text-4xl font-bold text-white mb-2 RMSE-value">168.34</div>
      <p class="text-sm text-gray-400">Root Mean Squared Error (lower is better)</p>
      <div class="mt-4">
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div class="bg-orange-500 h-2.5 rounded-full RMSE-bar" style="width: 35%"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Metrics History Chart -->
  <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
    <h2 class="text-xl font-semibold text-cyan-300 mb-4">Metrics History</h2>
    <div class="h-80">
      <canvas id="metricsChart"></canvas>
    </div>
  </div>
  
  <!-- Recent Runs Table -->
  <div class="bg-gray-800 p-6 rounded-2xl shadow-xl">
    <h2 class="text-xl font-semibold text-cyan-300 mb-4">Recent Runs</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-700">
        <thead>
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Run ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Model</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">R²</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">MAE</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">RMSE</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Date</th>
          </tr>
        </thead>
        <tbody class="bg-gray-900 divide-y divide-gray-800" id="runsTableBody">
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">f8a92e5b</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">Raw</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400">0.87</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400">102.60</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-400">168.34</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">2025-05-07</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">c4d19a7f</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">Smoothed</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400">0.98</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400">37.50</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-400">55.72</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">2025-05-07</td>
          </tr>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">b2e71d3c</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">Hybrid</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-400">0.89</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-400">84.9</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-400">148.14</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">2025-05-07</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Model data
  const modelData = {
    'raw': {
      r2: 0.86,
      MAE: 102.60,
      RMSE: 168.34,
      history: {
        dates: ['May 1', 'May 5', 'May 6', 'May 6'],
        r2: [0.78, 0.78, 0.86, 0.86],
        MAE: [15.2, 14.1, 13.2, 102.60],
        RMSE: [3.9, 3.75, 3.63, 168.34]
      }
    },
    'smoothed': {
      r2: 0.98,
      MAE: 37.50,
      RMSE: 55.72,
      history: {
        dates: ['May 1', 'May 5', 'May 6', 'May 6'],
        r2: [0.80, 0.81, 0.81, 0.98],
        MAE: [11.5, 10.8, 10.2, 37.50],
        RMSE: [3.39, 3.29, 3.19, 55.72]
      }
    },
    'hybrid': {
      r2: 0.89,
      MAE: 84.9,
      RMSE: 148.14,
      history: {
        dates: ['May 1', 'May 5', 'May 10', 'May 6'],
        r2: [0.89, 0.89, 0.88, 0.89],
        MAE: [9.8, 8.9, 7.8, 84.9],
        RMSE: [55.72, 2.98, 2.79, 148.14]
      }
    }
  };
  
  // Initialize metrics chart
  let metricsChart;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize chart
    const ctx = document.getElementById('metricsChart').getContext('2d');
    metricsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'R²',
            data: [],
            borderColor: 'rgba(6, 182, 212, 1)',
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'MAE',
            data: [],
            borderColor: 'rgba(239, 68, 68, 1)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          },
          {
            label: 'RMSE',
            data: [],
            borderColor: 'rgba(249, 115, 22, 1)',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'R²',
              color: 'rgba(255, 255, 255, 0.7)'
            },
            min: 0.8,
            max: 1.0,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'MAE / RMSE',
              color: 'rgba(255, 255, 255, 0.7)'
            },
            min: 0,
            max: 20,
            grid: {
              drawOnChartArea: false,
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          },
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: 'rgba(255, 255, 255, 0.7)'
            }
          }
        }
      }
    });
    
    // Set up model button click handlers
    document.querySelectorAll('.model-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        this.classList.add('active');
        
        // Get model type from button id
        const modelType = this.id.replace('ModelBtn', '').toLowerCase();
        updateMetrics(modelType);
      });
    });
    
    // Initialize with raw model
    updateMetrics('raw');
  });
  
  function updateMetrics(modelType) {
    const data = modelData[modelType];
    
    // Update metric values
    document.querySelector('.r2-value').textContent = data.r2.toFixed(2);
    document.querySelector('.MAE-value').textContent = data.MAE.toFixed(2);
    document.querySelector('.RMSE-value').textContent = data.RMSE.toFixed(2);
    
    // Update progress bars
    document.querySelector('.r2-bar').style.width = `${data.r2 * 100}%`;
    document.querySelector('.MAE-bar').style.width = `${Math.min(100, (data.MAE / 20) * 100)}%`;
    document.querySelector('.RMSE-bar').style.width = `${Math.min(100, (data.RMSE / 10) * 100)}%`;
    
    // Update chart
    metricsChart.data.labels = data.history.dates;
    metricsChart.data.datasets[0].data = data.history.r2;
    metricsChart.data.datasets[1].data = data.history.MAE;
    metricsChart.data.datasets[2].data = data.history.RMSE;
    metricsChart.update();
  }
</script>
{% endblock %}
